import{Z as I,J as D,W as O,I as C}from"./index-CKF4anYh.js";const $=.5,h={x:0,y:0},M=0;function b(o,s,t,i,e,a){const{height:n,width:c}=s,l=n*c,r=S(k(l)),d=Math.min(l,o.actualOptions.particles.number.value),u=o.canvas.size;let m=0;const p={x:u.width*t.x/I-c*i*$,y:u.height*t.y/I-n*i*$};for(;m<d&&r.length;){const g=r.pop()??0,x={x:g%c,y:Math.floor(g/c)},w=s.pixels[x.y][x.x];if(!a(w))continue;const P={x:x.x*i+p.x,y:x.y*i+p.y},y={};e.color&&(y.color={value:w}),e.opacity&&(y.opacity={value:w.a}),o.particles.addParticle(P,y),m++}}function v(o,s,t,i=!0){const e=o.getImageData(h.x,h.y,s.width,s.height).data;i&&o.clearRect(h.x,h.y,s.width,s.height);const a=[];for(let n=0;n<e.length;n+=t){const c=n/t,l={x:c%s.width,y:Math.floor(c/s.width)};a[l.y]||(a[l.y]=[]);const r={r:0,g:1,b:2,a:3},d=255;a[l.y][l.x]={r:e[n+r.r],g:e[n+r.g],b:e[n+r.b],a:e[n+r.a]/d}}return{pixels:a,width:Math.min(...a.map(n=>n.length)),height:a.length}}function B(o,s){const t=new Image;t.crossOrigin="Anonymous";const i=new Promise((e,a)=>{t.onerror=a,t.onload=()=>{const n=document.createElement("canvas");n.width=t.width,n.height=t.height;const c=n.getContext("2d");if(!c)return a(new Error(`${D} Could not get canvas context`));c.drawImage(t,h.x,h.y,t.width,t.height,h.x,h.y,n.width,n.height),e(v(c,n,s))}});return t.src=o,i}function A(o,s){const t=document.createElement("canvas"),i=t.getContext("2d"),{font:e,text:a,lines:n,color:c}=o;if(!a||!i)return;const l=a.split(n.separator),r=O(e.size)?`${e.size}px`:e.size,d=[];let u=0,m=0;for(const f of l){i.font=`${e.style??""} ${e.variant??""} ${e.weight??""} ${r} ${e.family}`;const g=i.measureText(f),x={measure:g,text:f,height:g.actualBoundingBoxAscent+g.actualBoundingBoxDescent,width:g.width};u=Math.max(u||M,x.width),m+=x.height+n.spacing,d.push(x)}t.width=u,t.height=m;let p=0;for(const f of d)i.font=`${e.style??""} ${e.variant??""} ${e.weight??""} ${r} ${e.family}`,i.fillStyle=c,i.fillText(f.text,h.x,p+f.measure.actualBoundingBoxAscent),p+=f.height+n.spacing;return v(i,t,s)}function S(o){for(let i=o.length-1;i>=0;i--){const e=Math.floor(C()*i);[o[i],o[e]]=[o[e],o[i]]}return o}const k=o=>[...Array(o).keys()];class W{constructor(s){this._container=s}async init(){const s=this._container,t=s.actualOptions.canvasMask;if(!(t!=null&&t.enable))return;let i={pixels:[],height:0,width:0};const e=t.pixels.offset;if(t.image){const a=t.image.src;if(!a)return;i=await B(a,e)}else if(t.text){const a=t.text,n=A(a,e);if(!n)return;i=n}else if(t.element??t.selector){const a=t.element??(t.selector&&document.querySelector(t.selector));if(!a)return;const n=a.getContext("2d");if(!n)return;i=v(n,a,e)}b(s,i,t.position,t.scale,t.override,t.pixels.filter)}}export{W as CanvasMaskInstance};
